# Mini Python 編譯器項目
> 將 Python 代碼優雅地轉化為 x86-64 彙編

## 團隊成員
- 王品翔 (111820023)
- 楊承諭 (111820030)  
- 江子文 (111820033)

## 1. 項目概述

### 簡介
一個簡易的 Mini Python 編譯器，它能夠將 Python 轉換為 x86-64 彙編代碼。

### 完成度總結
- 基本數據類型: int, bool, string, list ✓
- 運算符: 算術運算(+,-,*,/,%), 比較運算(<,<=,>,>=,==,!=), 邏輯運算(and,or) ✓
- 控制結構: for 循環 ✓
- 內建函數: len() ✓
- 錯誤處理: 運行時錯誤檢查 ✓

## 2. 技術選擇

### 使用的技術棧
- 實現語言: OCaml
- 記憶體管理: 使用 malloc 進行堆分配

### 關鍵決策說明
1. 記憶體佈局:
   - 每個值佔用 16 字節
   - 前 8 字節存放類型標籤
   - 後 8 字節存放實際數據
2. 堆棧與寄存器使用:
   - 堆棧對齊: 調用庫函數時需確保 16 字節對齊
   - 使用堆棧存儲中間計算結果
   - 參數通過堆棧傳遞
   - 返回值使用 %rax 寄存器
2. 類型標籤:
   - None: 0
   - Bool: 1
   - Int: 2
   - String: 3
   - List: 4

## 3. 功能實現

### 基本功能
1. 數值運算:
   - 支持整數的加減乘除和取模運算
   - 支持一元負號運算
   - 所有運算都基於有符號 64 位整數
2. 布爾運算:
   - 支持 and/or/not 運算
   - 支持所有比較運算符 (<,<=,>,>=,==,!=)
   - False/0/空字符串/空列表被視為假值
   - 其他值被視為真值
3. 列表操作:
   - 支持列表創建 [e1, e2, ...]
   - 支持索引訪問 l[i] 和賦值 l[i] = e
   - 支持 list(range(n)) 創建整數序列
4. 字符串:
   - 支持字符串常量和轉義序列 (\", \n)
   - 支持字符串連接操作 (+)
   - 支持字符串比較(字典序)
5. 多維列表操作:
   - 支持嵌套列表訪問 (如 x[1][2])
   - 遞歸處理嵌套的列表訪問
   - 為每層訪問生成索引檢查代碼
6. 短路求值:
   - and/or 運算符的短路求值優化
   - 使用條件跳轉實現
   - 避免不必要的表達式求值

### 錯誤處理
- 運行時檢查:
  - 除零錯誤
  - 列表索引越界
  - 類型錯誤
  - len() 參數類型檢查

### 測試案例
參考 tests-mini-python/exec/ tests-mini-python/exec-fail/ tests-mini-python/typing/ 中的測試用例列表
### 語言特性補充
1. 作用域規則:
   - 變量作用域為靜態定義
   - 變量可以是函數局部變量或全局變量
   - 局部變量通過參數或賦值引入
   - 全局變量通過頂層代碼賦值引入
   - 不支持變量遮蔽(shadowing)

2. 內建函數限制:
   - list(range()) 只能作為複合表達式使用
   - range() 參數必須為非負整數

### 與 Python 的主要差異
1. 算術運算: 使用有符號 64 位整數，而非 Python 的無限精度
2. 列表顯示: 字符串在列表中顯示時不帶引號
3. 不支持字符串/列表與整數相乘
4. 不支持負數索引訪問



## 5. 已知問題

### 現存問題
1. 字符串比較可能存在記憶體問題
2. 某些錯誤情況下的錯誤信息不夠具體

## 6. 使用說明

### 安裝步驟
1. 安裝 OCaml 和必要的依賴
2. 編譯項目源碼

### 運行方式
1. 編譯源文件:
   ```bash
   cd mini-python-ocaml
   make
   ```
2. 運行生成的程序:
   ```bash
   cd ../tests-mini-python
   ./test -3 ../mini-python-ocaml/mini-python
   ```

## 7. 測試案例
### 執行結果
```
Part 2 (type checking)
bad ..............
good ..................................................
Typing: 64/64 : 100%
```
```
Part 3 (code generation)
Compilation:
Compilation: 38/48 : 79%
Code behavior: 37/48 : 77%
Expected output: 37/48 : 77%
```
